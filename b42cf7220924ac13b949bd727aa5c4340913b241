{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "632a02b8_9af608a3",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 14,
      "author": {
        "id": 13640
      },
      "writtenOn": "2023-07-12T15:10:48Z",
      "side": 1,
      "message": "Do we actually need seq cst? My understanding is that acquire/release should be sufficient for the atomics implemented.",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 14,
        "endChar": 75
      },
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a1360df9_4ea04974",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 14,
      "author": {
        "id": 7530
      },
      "writtenOn": "2023-07-13T09:38:15Z",
      "side": 1,
      "message": "Go mem spec requires seq cst, if we don\u0027t follow this requirement, hardware with numa support will failed with timeout or hanged (issue #61295)",
      "parentUuid": "632a02b8_9af608a3",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 14,
        "endChar": 75
      },
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2985a3c0_d106a1db",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 5200
      },
      "writtenOn": "2023-07-12T15:49:10Z",
      "side": 1,
      "message": "I guess the remaining question is, is #51295 fixed if we mark LR as acquire only?",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "24e6499e_d55ecf7f",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2075,
      "author": {
        "id": 6875
      },
      "writtenOn": "2023-07-11T16:31:28Z",
      "side": 1,
      "message": "I\u0027m a bit wary of redefining what assembly instructions do. Maybe we should add different LR variants as different instructions?\n \nI guess this is safe, as adding sync marks can\u0027t hurt (except perhaps performance-wise).\n\nIs this change necessary, given the fix to the other instructions below? My intuitions says LR needs only acquire semantics.",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "eb34e185_96759888",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2075,
      "author": {
        "id": 7530
      },
      "writtenOn": "2023-07-12T03:07:23Z",
      "side": 1,
      "message": "I grepped Go repo and only runtime/internal/atomic using this LR, I think it\u0027s safe to change this default encoding. GNU as using suffix for different mode i.e. `lr.w.aqrl`. Maybe we can add this later in 1.22 after floating point round mode CL 504737 been apply?",
      "parentUuid": "24e6499e_d55ecf7f",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "61d0d6f1_44babfd7",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2075,
      "author": {
        "id": 13640
      },
      "writtenOn": "2023-07-12T15:10:48Z",
      "side": 1,
      "message": "There\u0027s a bit to unpack here...\n\nIt looks like the real issue here is that SC is setting \u0027aq\u0027 instead of \u0027rl\u0027 (which , combined with \u0027rl\u0027 being needed on the AMO* instructions. I do not believe that we need or want \u0027aqrl\u0027 for LR. To quote the RISC-V ISA:\n\n\"Software should not set the rl bit on an LR instruction unless the aq bit is also set, nor should software set the aq bit on an SC instruction unless the rl bit is also set. LR.rl and SC.aq instructions are not guaranteed to provide any stronger ordering than those with both bits clear, but may result in lower performance.\"\n\nI\u0027m not really concerned by changing the assembly opcodes - very few things use these instructions (I\u0027d be surprised if there is anything outside of the Go\u0027s runtime/internal/atomic package) and the change is to fix incorrect operations (which only improves the situation by strengthening ordering).\n\nI do not think we should add suffixed modes - that seems unnecessary and would only potentially lead to further incorrect usage/performance issues.",
      "parentUuid": "eb34e185_96759888",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cea2ee0a_9e5b3e91",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2075,
      "author": {
        "id": 5200
      },
      "writtenOn": "2023-07-12T15:49:10Z",
      "side": 1,
      "message": "My worry would be about other repos using these instructions, not the stdlib.\n\nBut it should be ok as long as we are only constraining behavior, or fixing obvious bugs.",
      "parentUuid": "61d0d6f1_44babfd7",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "96524b6d_e7c92c8d",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2075,
      "author": {
        "id": 7530
      },
      "writtenOn": "2023-07-13T09:38:15Z",
      "side": 1,
      "message": "SC only set with \"rl\" not \"aq\" (Line 2077).\nAs for LR, I think what ISA means \"lr.rl/sc.aq\" pairs has no good instead of \"lr.aqrl/sc.rl\" pairs. There is also a note at the end of A.6 \"however that the two mappings only interoperate correctly if atomic \u003cop\u003e(memory order seq cst) is mapped using an LR that has both aq and rl set\"",
      "parentUuid": "cea2ee0a_9e5b3e91",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "34533d11_ff31a957",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2075,
      "author": {
        "id": 13640
      },
      "writtenOn": "2023-07-13T10:17:06Z",
      "side": 1,
      "message": "In the existing code, SC (and all AMO*) are using .aq only, no?\n\nHave you tested on the NUMA hardware if using lr.aq, sc.rl and amo*.aqrl solves the issue (I suspect the real issue is likely the absence of \u0027rl\u0027)?\n\nAlso, I believe that above reference re interoperation is specifically regarding the possible future addition of \"load and store opcodes with aq and rl modifiers are introduced\".\n\nLastly, if lr.aqrl is actually required, have you tested the performance impact of this?",
      "parentUuid": "96524b6d_e7c92c8d",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fff2c6ae_156f31d2",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2075,
      "author": {
        "id": 7530
      },
      "writtenOn": "2023-07-13T12:43:02Z",
      "side": 1,
      "message": "You are right about the real issue is absence of `rl`.\n\nI can\u0027t make a baseline from master/go1.21rc2 because they all crashed during test.\n```\ngoos: linux\ngoarch: riscv64\npkg: runtime/internal/atomic\n                 │ /root/lr.aq.bench.log │       /root/lr.aqrl.bench.log       │\n                 │        sec/op         │   sec/op     vs base                │\nAtomicLoad64-64              18.76n ± 1%   29.71n ± 1%  +58.40% (p\u003d0.000 n\u003d10)\nAtomicStore64-64             45.76n ± 1%   45.80n ± 1%        ~ (p\u003d0.590 n\u003d10)\nAtomicLoad-64                18.60n ± 0%   29.82n ± 1%  +60.34% (p\u003d0.000 n\u003d10)\nAtomicStore-64               45.79n ± 1%   45.74n ± 0%        ~ (p\u003d0.323 n\u003d10)\nAnd8-64                      49.76n ± 1%   49.83n ± 1%        ~ (p\u003d0.066 n\u003d10)\nAnd-64                       49.73n ± 0%   49.77n ± 0%        ~ (p\u003d0.116 n\u003d10)\nAnd8Parallel-64              31.48n ± 1%   31.49n ± 1%        ~ (p\u003d0.897 n\u003d10)\nAndParallel-64               31.71n ± 1%   31.15n ± 1%   -1.77% (p\u003d0.000 n\u003d10)\nOr8-64                       49.80n ± 1%   49.75n ± 1%        ~ (p\u003d0.423 n\u003d10)\nOr-64                        49.85n ± 1%   49.74n ± 1%        ~ (p\u003d0.493 n\u003d10)\nOr8Parallel-64               31.32n ± 1%   31.12n ± 2%        ~ (p\u003d0.211 n\u003d10)\nOrParallel-64                31.16n ± 1%   31.37n ± 1%        ~ (p\u003d0.617 n\u003d10)\nXadd-64                      31.55n ± 1%   31.43n ± 1%        ~ (p\u003d0.148 n\u003d10)\nXadd64-64                    31.32n ± 2%   31.45n ± 1%        ~ (p\u003d0.897 n\u003d10)\nCas-64                       3.498µ ± 3%   3.357µ ± 7%   -4.03% (p\u003d0.011 n\u003d10)\nCas64-64                     3.744µ ± 7%   3.383µ ± 2%   -9.64% (p\u003d0.000 n\u003d10)\nXchg-64                      31.38n ± 1%   31.32n ± 1%        ~ (p\u003d0.671 n\u003d10)\nXchg64-64                    31.34n ± 1%   31.48n ± 1%        ~ (p\u003d0.256 n\u003d10)\ngeomean                      58.03n        60.58n        +4.39%\n```",
      "parentUuid": "34533d11_ff31a957",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "061bf4ed_37f80943",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2080,
      "author": {
        "id": 6875
      },
      "writtenOn": "2023-07-11T16:31:28Z",
      "side": 1,
      "message": "This definitely looks like just a bug in the old code. SC should definitely be release, not acquire.",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "450fe154_2293a5e4",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2080,
      "author": {
        "id": 7530
      },
      "writtenOn": "2023-07-12T03:07:23Z",
      "side": 1,
      "message": "Should I send two CLs?",
      "parentUuid": "061bf4ed_37f80943",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "62055756_33490c19",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2080,
      "author": {
        "id": 13640
      },
      "writtenOn": "2023-07-12T15:10:48Z",
      "side": 1,
      "message": "Fixing SC and AMO* in the same CL seems sensible to me.",
      "parentUuid": "450fe154_2293a5e4",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "962250af_0fa8418e",
        "filename": "src/cmd/internal/obj/riscv/obj.go",
        "patchSetId": 2
      },
      "lineNbr": 2080,
      "author": {
        "id": 5200
      },
      "writtenOn": "2023-07-12T15:49:10Z",
      "side": 1,
      "message": "A single CL is fine.",
      "parentUuid": "62055756_33490c19",
      "revId": "b42cf7220924ac13b949bd727aa5c4340913b241",
      "serverId": "62eb7196-b449-3ce5-99f1-c037f21e1705"
    }
  ]
}