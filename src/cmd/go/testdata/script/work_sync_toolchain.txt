
# Create basic modules and work space.
env TESTGO_VERSION=go1.50
mkdir m1
go mod init -C m1
go mod edit -C m1 -go=1.22.0 -toolchain=go1.23.0
mkdir m2
go mod init -C m2
go mod edit -C m2 -go=1.22.1 -toolchain=go1.22.3
mkdir m3
go mod init -C m3
go mod edit -C m3 -go=1.22.0 -toolchain=go1.23.1
mkdir m4
go mod init -C m4
go mod edit -C m4 -go=1.24rc1
go work init ./m1 ./m2
grep '^go 1.50$' go.work
! grep toolchain go.work

# work sync with older modules should leave go 1.50 in the go.work.
go work sync
cat go.work
grep '^go 1.50$' go.work
! grep toolchain go.work

# work sync with newer modules should update go 1.21 -> 1.22.1 and toolchain -> go1.22.9 in go.work
env TESTGO_VERSION=go1.21
env TESTGO_VERSION_SWITCH=switch
go work edit -go=1.21
grep '^go 1.21$' go.work
! grep toolchain go.work
go work sync
stderr '^go: switching to go1.23.9$'
grep '^go 1.22.1$' go.work
cat go.work
grep '^toolchain go1.23.9$' go.work

# work sync with newer modules should update toolchain -> go1.23.9 in go.work
go work edit -go=1.21 -toolchain=none -use=./m3
go work sync
stderr '^go: switching to go1.23.9$'
grep '^go 1.22.1$' go.work
grep '^toolchain go1.23.9$' go.work

# work sync with newer modules should update go 1.22.1 -> 1.24rc1 and drop toolchain
go work edit -use=./m4
go work sync
grep '^go 1.24rc1$' go.work
! grep toolchain go.work
