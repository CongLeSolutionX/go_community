# Tests for automatic testing.Init calls when using 'go test'.

env GO111MODULE=on

# Tests running under 'go test' should observe that testing.Init is called
# before any user package initialization code runs.
# A TestMain should be able to access testing flags if it calls flag.Parse
# without needing to use testing.Init.
# Though it is ill-advised, a dependency of a test should be able to call
# flag.Parse during initialization without breaking 'go test' as long as it
# imports "testing". See golang.org/issue/31859.
go test
stdout TestInit
stdout TestMain
stdout TestExt

-- go.mod --
module m

-- init_test.go --
package testinitflag

import (
	_ "m/dep"
	"flag"
	"fmt"
	"os"
	"testing"
)

func testFlagsInitialized() bool {
	found := false
	flag.VisitAll(func(f *flag.Flag) {
		if f.Name == "test.count" {
			found = true
		}
	})
	return found
}

var testingInitAtInitialization = testFlagsInitialized()

func TestInit(t *testing.T) {
	if !testingInitAtInitialization {
		t.Fatal("testing.Init not called before package initialization")
	}
	fmt.Printf("TestInit\n")
}

func TestMain(m *testing.M) {
	fmt.Printf("TestMain\n")
	flag.Parse()
	if !testFlagsInitialized() {
		fmt.Println("testing flags not registered")
		os.Exit(1)
	}
	os.Exit(m.Run())
}

-- external_test.go --
package testinitflag_test

import (
	"flag"
	"fmt"
	"testing"
)

func testFlagsInitialized() bool {
	found := false
	flag.VisitAll(func(f *flag.Flag) {
		if f.Name == "test.count" {
			found = true
		}
	})
	return found
}

var testingInitAtInitialization = testFlagsInitialized()

func TestExt(t *testing.T) {
	fmt.Printf("TestExt\n")
	if !testingInitAtInitialization {
		t.Fatal("testing.Init not called before package initialization")
	}
}

-- dep/dep.go --
package dep

import (
	"flag"
	_ "testing"
)

func init() { flag.Parse() }
