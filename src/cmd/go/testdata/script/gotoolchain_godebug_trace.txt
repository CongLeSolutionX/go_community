# Test the GODEBUG=toolchaintrace behavior
# See https://go.dev/issue/63939
env GODEBUG=toolchaintrace=1

# Clear the path so this test doesn't fail if the system running it\
# has a binary named go1.21 or go1.22 on its path.
[GOOS:plan9] env path=
[!GOOS:plan9] env PATH=

# Go line is newer than local go version.
env TESTGO_VERSION=go1.14
go mod init m
go mod edit -go=1.21
! go version
stderr 'go: switching from go1.14\(local go version\) to go1.21.0\(go line in go.mod\)'
rm go.mod

# Toolchain line is newer than go line.
env TESTGO_VERSION=go1.14
go mod init m
go mod edit -go=1.21 -toolchain=go1.21.2
! go version
stderr 'go: switching from go1.14\(local go version\) to go1.21.2\(toolchain line in go.mod\)'
rm go.mod

# Go line is newer than local go version and toolchain line.
env TESTGO_VERSION=go1.14
go mod init m
go mod edit -go=1.22 -toolchain=go1.21.2
! go version
stderr 'go: switching from go1.14\(local go version\) to go1.21.2\(toolchain line in go.mod\)'
stderr 'go: switching from go1.21.2\(toolchain line in go.mod\) to go1.22.0\(go line in go.mod\)'
rm go.mod

# No switch.
env TESTGO_VERSION=go1.21.0
go mod init m
go mod edit -go=1.21.0 -toolchain=go1.21.0
go version
! stderr 'go: switched from'
rm go.mod

# GOTOOLCHAIN is older than go line and toolchain line.
env TESTGO_VERSION=go1.14
go mod init m
go mod edit -go=1.22 -toolchain=go1.21.2
env GOTOOLCHAIN=go1.21.0+auto
! go version
stderr 'go: switching from go1.14\(local go version\) to go1.21.0\(GOTOOLCHAIN=go1.21.0\+auto\)'
stderr 'go: switching from go1.21.0\(GOTOOLCHAIN=go1.21.0\+auto\) to go1.21.2\(toolchain line in go.mod\)'
stderr 'go: switching from go1.21.2\(toolchain line in go.mod\) to go1.22.0\(go line in go.mod\)'
rm go.mod
env GOTOOLCHAIN=auto

# GOTOOLCHAIN is newer than go line and toolchain line.
env TESTGO_VERSION=go1.14
go mod init m
go mod edit -go=1.21.0 -toolchain=go1.21.2
env GOTOOLCHAIN=go1.22.0+auto
! go version
stderr 'go: switching from go1.14\(local go version\) to go1.22.0\(GOTOOLCHAIN=go1.22.0\+auto\)'
rm go.mod
env GOTOOLCHAIN=auto

# If toolchain found in PATH, ensure we print that.
env TESTGO_VERSION=go1.21
mkdir $WORK/bin
go build -o $WORK/bin/go1.22.0$GOEXE ./fake/fakego.go  # adds .exe extension implicitly on Windows
[!GOOS:plan9] env PATH=$WORK/bin
[GOOS:plan9] env path=$WORK/bin
go mod init m
go mod edit -go=1.22.0
! go version
stderr 'go: using go1.22.0 from PATH'
stderr 'running go1.22.0 from PATH'
rm go.mod

# toolchaintrace outputs location of toolchain.
env TESTGO_VERSION=go1.14
env TESTGO_VERSION_SWITCH=switch
env GOTOOLCHAIN=auto
go mod init m
go mod edit -go=1.21.0
go version
stderr 'go: using go1.21.0 from'

-- fake/fakego.go --
package main

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"
)

func main() {
	exe, _ := os.Executable()
	name := filepath.Base(exe)
	name = strings.TrimSuffix(name, ".exe")
	fmt.Fprintf(os.Stderr, "running %s from PATH\n", name)
	os.Exit(1) // fail in case we are running this accidentally (like in "go mod edit")
}